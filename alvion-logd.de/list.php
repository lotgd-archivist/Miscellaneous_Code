
<?phprequire_once "common.php";require_once "func/kampfkunst.php";//    print_r($_GET['back']);//    print_r($_GET['backto']);//    var_dump(array_key_exists('back',$_GET));//    var_dump(array_key_exists('backto',$_GET));if ($session[user][loggedin]) {    checkday();    if ($session[user][alive]) {        if(array_key_exists('back',$_GET)){//            print_r($_GET['back']);            $back=$_GET['back'];            addnav("Zurück",$back);            addnav("Zum Dorf","village.php");        }elseif(array_key_exists('backto',$_GET)){//            print_r($_GET['backto']);            $back=$_GET['backto'];            $back = preg_replace("'[&?]c=[[:digit:]-]+'","",$back);            $back = substr($back,strrpos($back,"/")+1);            addnav("Zurück",$back);            addnav("Zum Dorf","village.php");        }else{            addnav("Zurück zum Dorf","village.php");            addnav("RP-Status ändern","list.php?op=aendern");        }    } else {        addnav("Zurück zu den Schatten", "shades.php");    }    if(isset($back)){            addnav("Gerade Online","list.php?back=".$back);        addnav("Admin Team","list.php?op=admin&back=".$back);        addnav("Priester","list.php?op=priester&back=".$back);    }    else{             addnav("Gerade Online","list.php");        addnav("Admin Team","list.php?op=admin");        addnav("Priester","list.php?op=priester");    }}else{    addnav("Login Seite","index.php");    addnav("Gerade Online","list.php");}$prefs = $session['user']['prefs'];page_header("Kämpferliste");$session['user']['standort']="Kämpferliste";db_query("UPDATE `accounts` SET `standort`='Kämpferliste' WHERE `acctid`='{$session['user']['acctid']}'");$playersperpage=50;$sql = "SELECT count(acctid) AS c FROM accounts WHERE locked=0";$result = db_query($sql);$row = db_fetch_assoc($result);$totalplayers = $row['c'];if ($_GET['op']=="search"){    $search="%";    for ($x=0;$x<strlen($_POST['name']);$x++){        $search .= substr($_POST['name'],$x,1)."%";    }    $search=" AND name LIKE '".addslashes($search)."' ";}else{    $pageoffset = (int)$_GET['page'];    if ($pageoffset>0) $pageoffset--;    $pageoffset*=$playersperpage;    $from = $pageoffset+1;    $to = min($pageoffset+$playersperpage,$totalplayers);    $limit=" LIMIT $pageoffset,$playersperpage ";}addnav("Seiten");for ($i=0;$i<$totalplayers;$i+=$playersperpage){    if(isset($back)) addnav("Seite ".($i/$playersperpage+1)." (".($i+1)."-".min($i+$playersperpage,$totalplayers).")","list.php?page=".($i/$playersperpage+1)."&back=".$back);    else addnav("Seite ".($i/$playersperpage+1)." (".($i+1)."-".min($i+$playersperpage,$totalplayers).")","list.php?page=".($i/$playersperpage+1));}if($_GET['op']=="aendern"){    if ($session[user][rpstatus]==0) {        output("RP Status auf \"Grün\" gesetzt.");        $session['user']['rpstatus']=1;        redirect("list.php");    } else if ($session[user][rpstatus]==1) {        output("RP Status auf \"Rot\" gesetzt.");        $session['user']['rpstatus']=0;        redirect("list.php");    }}// Order the list by level, dragonkills, name so that the ordering is total!// Without this, some users would show up on multiple pages and some users// wouldn't show upif ($_GET['page']=="" && $_GET['op']==""){    output("`c`bDiese Krieger sind gerade online`b`c");    $sql = "SELECT rpstatus,acctid,name,login,alive,location,sex,level,laston,loggedin,lastip,uniqueid,race,kunst,superuser,rp_only,standort,prefs,stealth,multi_allowed FROM accounts WHERE locked=0 AND loggedin=1 AND stealth=0 AND laston>'".date("Y-m-d H:i:s",strtotime(date("c")."-".getsetting("LOGINTIMEOUT",900)." seconds"))."' ORDER BY level DESC, dragonkills DESC, login ASC";}elseif($_GET['op']=="admin"){    output("`c`b`&Das Adminteam Alvions`0`b`n`n`&Die `\$Admins `&sind für euch da, wenn es um spieltechnische Fragen geht, sowie für Beschwerden, Fehler im Spiel`noder auch charspezifische Dinge wie Umbenennungen und Multi-Beantragungen.`c`0`n`n");    $sql = "SELECT rpstatus,acctid,name,login,alive,location,sex,level,laston,loggedin,lastip,uniqueid,race,kunst,superuser,rp_only,standort,prefs,stealth,multi_allowed FROM accounts WHERE locked=0 AND (superuser>=2 AND superuser<=5) ORDER BY login ASC";}elseif($_GET['op']=="priester"){    output("`c`b`=Die Priester Alvions`0`b`n`n`=Die `@Priester `=könnt ihr ansprechen, wenn es um Trauungen (auch per Klick), Beerdigungen oder auch Taufen im RP geht.`0`c`n`n");    $sql = "SELECT rpstatus,acctid,name,login,alive,location,sex,level,laston,loggedin,lastip,uniqueid,race,kunst,superuser,rp_only,standort,prefs,stealth,multi_allowed FROM accounts WHERE locked=0 AND superuser=1 ORDER BY login ASC";}else{    output("`c`bKrieger in dieser Welt (Seite ".($pageoffset/$playersperpage+1).": $from-$to von $totalplayers)`b`c");    $sql = "SELECT rpstatus,acctid,name,login,alive,location,sex,level,laston,loggedin,lastip,uniqueid,race,kunst,superuser,rp_only,standort,prefs,stealth,multi_allowed FROM accounts WHERE locked=0 $search ORDER BY level DESC, dragonkills DESC, login ASC $limit";}if ($session[user][loggedin]){    if(isset($back)){        output("<form action='list.php?op=search&back=".$back."' method='POST'>Nach Name suchen: <input name='name'><input type='submit' class='button' value='Suchen'></form>",true);        addnav("","list.php?op=search&&back=".$back);    }else{        output("<form action='list.php?op=search' method='POST'>Nach Name suchen: <input name='name'><input type='submit' class='button' value='Suchen'></form>",true);        addnav("","list.php?op=search");    }}$result = db_query($sql) or die(sql_error($sql));$max = db_num_rows($result);if ($max>100) {    output("`\$Es treffen zu viele Namen auf diese Suche zu. Nur die ersten 100 werden angezeigt.`0`n");}output("<table border=0 cellpadding=2 cellspacing=1 bgcolor='#999999'>",true);output("<tr class='trdark'><td><b>Level</b></td><td><b>Name</b></td><td><b>Rang</b></td>",true);if($_GET['op']=="priester") output("<td><b>Gesinnung</b></td>",true);output("<td><b>Char</b></td><td><b>Rasse</b></td>",true);if($prefs['keinekampfart']==0) output("<td><b>Kampfart</b></td>",true);output("<td><b><img src=\"images/female.gif\">/<img src=\"images/male.gif\"></b></td>",true);if($prefs['keinenort']==0) output("<td><b>Ort</b></td>",true);output("<td><b>Status</b></td><td><b>Zuletzt da</b></td><td><b>RP-Status</b></td>",true);if($session[user][superuser]>3) output("<td align=\"center\"><b>User-ID</b></td>",true);if($session[user][superuser]>=1 && $prefs['keinfix']==0) output("<td align=\"center\"><b>Navs `nreparieren</b></td>",true);if($session[user][superuser]>=3) output("<td align=\"center\"><b>erlaubter `nMulti</b></td>",true);output("</tr>",true);$char=array(0=>"Kämpfer",1=>"RP-Char",2=>"NPC");for($i=0;$i<$max;$i++){    $row = db_fetch_assoc($result);    output("<tr class='".($i%2?"trdark":"trlight")."'><td>",true);    output("`^$row[level]`0");    output("</td><td>",true);    if ($session[user][loggedin]) output("<a href=\"mail.php?op=write&to=".rawurlencode($row['login'])."\" target=\"_blank\" onClick=\"".popup("mail.php?op=write&to=".rawurlencode($row['login'])."").";return false;\"><img src='images/newscroll.GIF' width='16' height='16' alt='Mail schreiben' border='0'></a>",true);    if(isset($back)){        if ($session[user][loggedin]) output("<a href='bio.php?char=".rawurlencode($row['login'])."&back=".$back."' onClick='".popup("bio.php")."'>",true);        if ($session[user][loggedin]) addnav("","bio.php?char=".rawurlencode($row['login'])."&back=".$back."");    }else{        if ($session[user][loggedin]) output("<a href='bio.php?char=".rawurlencode($row['login'])."' onClick='".popup("bio.php")."'>",true);        if ($session[user][loggedin]) addnav("","bio.php?char=".rawurlencode($row['login'])."");    }    output("`".($row[acctid]==getsetting("hasegg",0)?"^":"&")."".$row['name']."`0",true);    if ($session[user][loggedin]) output("</a>",true);    output("</td><td>",true);    if ($row['superuser']==1){//        output("`@Priester");        output($row['sex']?"`@Priesterin":"`@Priester");    } else if ($row['superuser']>=2 && $row['superuser']<=3){        output("`qHelfer");    } else if ($row['superuser']>=4 && $row['superuser']<=5){        output($row['sex']?"`\$Admina":"`\$Admin");    } else {        output("Spieler");    }    output("</td><td>",true);    if($_GET['op']=="priester"){        $pprefs=unserialize($row['prefs']);        if ((int)$pprefs['priester']==1){            output("Hell");        }elseif ((int)$pprefs['priester']==2){            output("Dunkel");        }else    if ((int)$pprefs['priester']==3){            output("Hell/Dunkel");        }else{            output("Unbekannt");        }            output("</td><td>",true);    }    $char=array(0=>"Kämpfer",1=>"RP-Char",2=>"NPC");    output($char[$row['rp_only']]);    output("</td><td>",true);    output($row['race']);    if($prefs['keinekampfart']==0){        output("</td><td>",true);        output($kampfkunst[$row['kunst']]);    }    output("</td><td align=\"center\">",true);    output($row[sex]?"<img src=\"images/female.gif\" alt=\"weiblich\">":"<img src=\"images/male.gif\" alt=\"männlich\">",true);    if($prefs['keinenort']==0){        output("</td><td>",true);        $loggedin=(date("U") - strtotime($row[laston]) < getsetting("LOGINTIMEOUT",900) && $row[loggedin]);        if($loggedin){            $config = unserialize($row['prefs']);            if($config['stealthmode']!=1){                if($row['superuser']>=2 && $row['stealth']>0){                    output("`3".$row['standort']."`0");                } else {                    output("`&".$row['standort']."`0");                }            } else {                if($row['superuser']>=2 && $row['stealth']>0){                    output("`3Unbekannt`0");                } else {                    output("`&Unbekannt`0");                }            }        } else {            if ($row[location]==0 || $row[location]>=3 && !($row[location]==14 || $row[location]>=33)) output($loggedin?"`#Online`0":"`3Die Felder`0");            if ($row[location]==1) output("`3Zimmer in Kneipe`0");            if ($row[location]==2) output("`3Im Haus`0");            if ($row[location]==14) output("`3Im Kloster`0");            if ($row[location]==33) output("`3In der Gilde`0");            if ($row[location]==36) output("`3Unbekannt`0");        }    }        output("</td><td>",true);    output($row[alive]?"`1Lebt`0":"`4Tot`0");    output("</td><td>",true);    $laston=round((strtotime(date("c"))-strtotime($row[laston])) / 86400,0)." Tage";    if (substr($laston,0,2)=="1 ") $laston="1 Tag";    if (date("Y-m-d",strtotime($row[laston])) == date("Y-m-d")) $laston="Heute";    if (date("Y-m-d",strtotime($row[laston])) == date("Y-m-d",strtotime(date("c")."-1 day"))) $laston="Gestern";    if ($loggedin){        if($row['superuser']>=2 && $row['stealth']>0){            $laston="Heute";        }else{         $laston="Jetzt";        }    }    output($laston);    output("</td><td align=\"center\">",true);    output($row[rpstatus]?"<img src=\"images/gruen.jpg\"  alt=\"RP bereit\">":"<img src=\"images/rot.jpg\" alt=\"nicht bereit\">",true);    if($session['user']['superuser']>3){        output("</td><td align=\"center\"><a href=\"user.php?op=edit&userid=".$row['acctid']."&ret=kl\">".$row['acctid']."</a>",true);        addnav("","user.php?op=edit&userid=".$row['acctid']."&ret=kl");    }    if($session[user][superuser]>=1  && $prefs['keinfix']==0) {        output("</td><td align=\"center\"><a href='repnav.php?char=".rawurlencode($row['login'])."&id=".$row['acctid']."'>`\$Fix",true);        addnav("","repnav.php?char=".rawurlencode($row['login'])."&id=".$row['acctid']);    }    if($session['user']['superuser']>=3){        output("</td><td align=\"center\"><a href=\"su_multis.php?op=search&uid=".$row['acctid']."&ret=kl\">".($row['multi_allowed']?"`^Ja":"`4Nein")."</a>",true);        addnav("","su_multis.php?op=search&uid=".$row['acctid']."&ret=kl");    }    output("</td></tr>",true);}output("</table>",true);$onlinecount = 0; $spieler = 0; $admin = 0;$sql="SELECT superuser FROM accounts WHERE locked=0 AND loggedin=1 AND stealth=0  AND laston>'".date("Y-m-d H:i:s",strtotime(date("c")."-".getsetting("LOGINTIMEOUT",900)." seconds"))."' ORDER BY level DESC";$result = db_query($sql) or die(db_error($sql));while ($row = db_fetch_assoc($result)){    switch($row['superuser']){        case 0:        case 1:            $spieler++;        break;        case 2:        case 3:        case 4:        case 5:            $admin++;        break;        case 6:            $spieler++;        break;    }    $onlinecount++;}if($admin==1) output("`nEs sind $spieler Spieler und $admin Teammitglied in Alvion online.`n`n");else output("`nEs sind $spieler Spieler und $admin Teammitglieder in Alvion online.`n`n");page_footer();

