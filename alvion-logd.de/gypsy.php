
<?php// 1508004require_once "common.php";addcommentary();$cost = $session[user][level]*20;$gems=array(1=>1,2,3);$costs=array(1=>4000-3*getsetting("selledgems",0),7800-6*getsetting("selledgems",0),11400-9*getsetting("selledgems",0));$scost=1200-getsetting("selledgems",0);if ($_GET[op]=="pay"){    if ($session['user']['gold']>=$cost){        $session[user][gold]-=$cost;        //debuglog("spent $cost gold to speak to the dead");        if ($_GET[was]=="flirt"){             redirect("gypsy.php?op=flirt2");        } else {            redirect("gypsy.php?op=talk");        }    }else{        page_header("Zigeunerzelt");        addnav("Platz der alten Künste","kunstplatz.php");        addnav("Zurück zum Dorf","village.php");        output("`_Du bietest der Zigeunerin deine `^{$session[user][gold]}`_ Gold für die Beschwörungssitzung. Sie informiert dich, dass die Toten zwar tot, aber deswegen trotzdem nicht billig sind.");    }}elseif ($_GET[op]=="die"){    page_header("Zigeunerzelt");    if($session['user']['gold']>=$cost){        output("S`)e`=h`_e`=r`=i`jn `jV`=e`_s`=s`ja `_dreht sich um und bereitet, für dich unsichtbar, geheimnisvoll murmelnd einen Trank zu, "            ."den sie dir dann mit einem vielsagenden Ausdruck reicht. Schnell nimmst du ihn und leerst die Phiole "            ."und fast sofort merkst du, wie dir erst schwindelig, und dann schwarz vor Augen wird.`n`nDass du hart "            ."auf dem Boden aufschlägst, bekommst du schon nicht mehr mit...`n`n");        $session['user']['gold']-=$cost;        $session['user']['hitpoints']=0;        $session['user']['alive']=0;        addnews($session['user']['name']."`j wollte unbedingt zu ".($session['user']['sex']?"ihren":"seinen")." Ahnen. Nun ist ".($session['user']['sex']?"sie":"er")." dort.");        addnav("Zu den News","news.php");    }else{        output("`jWillst du mich neppen? Verschwinde hier und komm wieder, wenn du auch bezahlen kannst!`n`n");        addnav("Zurück","kunstplatz.php");    }}elseif ($_GET[op]=="talk"){    page_header("In tiefer Trance sprichst du mit den Schatten");    // by nTE- with modifications from anpera    $sql="SELECT name FROM accounts WHERE locked=0 AND loggedin=1 AND alive=0 AND laston>'".date("Y-m-d H:i:s",strtotime(date("c")."-".getsetting("LOGINTIMEOUT",900)." seconds"))."' ORDER BY login ASC";    $result=db_query($sql) or die(sql_error($sql));    $count=db_num_rows($result);    $names=$count?"":"niemandem";    for ($i=0;$i<$count;$i++){        $row=db_fetch_assoc($result);        $names.="`^$row[name]";        if ($i<$count-1) $names.=", ";    }        db_free_result($result);    output("`_Du fühlst die Anwesenheit von $names`_.`n`n");    output("`_Solange du in tiefer Trance bist, kannst du mit den Toten sprechen:`n");    viewcommentary("shade","Sprich zu den Toten",25,"spricht");    output("`n`n`7Farbcodes:`n");    $result = db_query("SELECT allowed, code FROM appoencode WHERE allowed='1'");    while ($row = db_fetch_assoc($result))    {        output("`$row[code]&#0096;$row[code]`0",true);    }    addnav("Erwachen","gypsy.php");} else if ($_GET[op]=="flirt2"){    page_header("In tiefer Trance sprichst du mit den Schatten");    output("`jV`=e`_s`=s`ja `_versetzt dich in tiefe Trance.`n`% Du findest ".($session[user][sex]?"deinen Mann":"deine Frau")." im Land der Schatten und flirtest eine Weile mit ".($session[user][sex]?"ihm, um sein":"ihr, um ihr")." Leid zu lindern. ");    output("`n`^Du bekommst einen Charmepunkt.");    $session['bufflist']['lover']=array("name"=>"`!Schutz der Liebe","rounds"=>60,"wearoff"=>"`!Du vermisst deine große Liebe!`0","defmod"=>1.2,"roundmsg"=>"Deine große Liebe lässt dich an deine Sicherheit denken!","activate"=>"defense");    $session['user']['charm']++;    $session['user']['seenlover']=1;    addnav("Erwachen","gypsy.php");}elseif($_GET[op]=="buy"){    page_header("Zigeunerzelt");    if ($session[user][transferredtoday]>getsetting("transferreceive",3)){        output("`_Du hast heute schon genug Geschäfte gemacht. `jV`=e`_s`=s`ja`_ hat keine Lust, mit dir zu handeln. Warte bis morgen.");    }else if ($session[user][gems]>getsetting("selledgems",0)) {        output("`jV`=e`_s`=s`ja `_wirft einen neidischen Blick auf dein Säckchen Edelsteine und beschließt, dir nichts mehr zu geben.");    } else {                if ($session[user][gold]>=$costs[$_GET[level]]){                       if (getsetting("selledgems",0) >= $_GET[level]) {                              output( "`6Vessa`_ grapscht sich deine `^".($costs[$_GET[level]])."`_ Goldstücke und gibt dir im Gegenzug `#".($gems[$_GET[level]])."`_ Edelstein".($gems[$_GET[level]]>=2?"e":"").".`n`n");                              $session[user][gold]-=$costs[$_GET[level]];                              $session[user][gems]+=$gems[$_GET[level]];                $session[user][transferredtoday]+=1;                              if (getsetting("selledgems",0) - $_GET[level] < 1) {                                savesetting("selledgems","0");                              } else {                                savesetting("selledgems",getsetting("selledgems",0)-$_GET[level]);                              }                       } else {                              output("`jV`=e`_s`=s`ja`_ teilt dir mit, dass sie nicht mehr so viele Edelsteine hat und bittet dich, später noch einmal wiederzukommen.`n`n");                       }                }else{                        output( "`jV`=e`_s`=s`ja`_ zeigt dir den Stinkefinger, als du versuchst, ihr weniger zu zahlen als, ihre Edelsteine momentan Wert sind.`n`n");                }    }    addnav("Platz der alten Künste","kunstplatz.php");    addnav("Zurück zum Dorf","village.php");}elseif($_GET[op]=="sell"){    page_header("Zigeunerzelt");    $maxout = $session[user][level]*getsetting("maxtransferout",25);        if ($session[user][gems]<1){                output("`jV`=e`_s`=s`ja`_ haut mit der Faust auf den Tisch und fragt dich, ob du sie veralbern willst. Du hast keinen Edelstein.`n`n");    }else if ($session[user][transferredtoday]>getsetting("transferreceive",3)){        output("`_Du hast heute schon genug Geschäfte gemacht. `jV`=e`_s`=s`ja`_ hat keine Lust, mit dir zu handeln. Warte bis morgen.");        }else{                output("`jV`=e`_s`=s`ja`_ nimmt deinen Edelstein und gibt dir dafür $scost Goldstücke.`n`n");                $session[user][gold]+=$scost;                $session[user][gems]-=1;                savesetting("selledgems",getsetting("selledgems",0)+1);        $session[user][transferredtoday]+=1;        }    addnav("Zigeunerzelt","gypsy.php");    addnav("Platz der alten Künste","kunstplatz.php");    addnav("Zurück zum Dorf","village.php");}elseif($_GET[op]=="p38"){    page_header("Zigeunerzelt");    $sql = "SELECT * FROM items WHERE owner=".$session[user][acctid]." AND class='Dokument' AND name='`9Das blaue Formular'";    $result = db_query($sql);    if (db_num_rows($result)>0){        output("`jV`=e`_s`=s`ja`_ haut mit der Faust auf den Tisch und fragt dich, ob du sie veralbern willst. Du hast doch schon das blaue Formular.`n`n");    } else {        $sql = "SELECT * FROM items WHERE owner=".$session[user][acctid]." AND class='Dokument' AND name='`7Antrag U56'";        $result = db_query($sql);        if (db_num_rows($result)==0){            output("`jV`=e`_s`=s`ja`_ schaut dich fragend an. \"Du hast doch den Antrag U56? Ohne U56 kein blaues Formular!\" Genervt wendest du dich ab.");            $session['user']['p38']=$session['user']['p38'] | 4;        } else {            output("`_Sie nickt und sagt \"Wie ich sehe, besitzt du den Antrag U56, also werde ich dir für die Kleinigkeit von einem Edelstein das blaue Formular verkaufen.\"`n`n");            output("`&Einen Edelstein für das blaue Formular ausgeben?`n");                addnav("Kauf bestätigen?");                addnav("JA","gypsy.php?op=p38confirm");            addnav("Zurück");            addnav("Zurück zu Vessa","gypsy.php");        }    }    addnav("Platz der alten Künste","kunstplatz.php");    addnav("Zurück zum Dorf","village.php");}elseif($_GET[op]=="p38confirm"){    page_header("Zigeunerzelt");    if($session['user']['gems']>0) {        output("`jV`=e`_s`=s`ja`_ nimmt den Antrag U56 und den Edelstein entgegen und reicht dir das blaue Formular.");        $sql="UPDATE items SET name='`9Das blaue Formular', gems='1', gold='500', description='Ein eng beschriebenes Formular auf blauem Pergament' WHERE owner='".$session[user][acctid]."' AND name='`7Antrag U56'";        db_query($sql);        $session['user']['gems']--;    } else {        output("`jV`=e`_s`=s`ja`_ haut mit der Faust auf den Tisch und fragt dich, ob du sie veralbern willst. Du hast keinen Edelstein.`n`n");    }    addnav("Zigeunerzelt","gypsy.php");    addnav("Platz der alten Künste","kunstplatz.php");    addnav("Zurück zum Dorf","village.php");}else{    checkday();    page_header("Zigeunerzelt");    output("`_Du betrittst das Zigeunerzelt, in dem dir eine Unterhaltung mit den Verstorbenen versprochen wird. Im typischen Zigeunerstil sitzt eine Frau hinter    einer irgendwie schmierigen Kristallkugel. Sie sagt dir, dass die Verstorbenen nur mit den Bezahlenden reden. Der Preis ist `^$cost`_ Gold.");    output("`nDie `jS`)e`=h`_e`=r`=i`jn `jV`=e`_s`=s`ja`_ gibt dir auch zu verstehen, dass sie mit Edelsteinen handelt.`nMomentan hat sie `#".getsetting("selledgems",0)."`_ Edelsteine auf Lager.");    if (getsetting("selledgems",0)>=1000) output(" Sie scheint aber kein Interesse an weiteren Edelsteinen zu haben. Oder sie hat einfach kein Gold mehr, um weitere Edelsteine zu kaufen.");    addnav("Bezahle und rede mit den Toten","gypsy.php?op=pay");    if ($session[user][charisma]==4294967295 && $session[user][seenlover]<1) {          $sql = "SELECT name,alive FROM accounts WHERE ".$session[user][marriedto]." = acctid ORDER BY charm DESC";          $result = db_query($sql) or die(db_error(LINK));        $row = db_fetch_assoc($result);        if ($row[alive]==0) addnav("Bezahle und flirte mit $row[name]","gypsy.php?op=pay&was=flirt");    }    if ($session['user']['orden']>=24) addnav("Bezahle und gehe zu den Toten","gypsy.php?op=die");    //addnav("Tarotkarten legen (1 Edelstein)","tarot.php");    if ($session[user][superuser]>1) addnav("Superusereintrag","gypsy.php?op=talk");    addnav("Edelsteine");    if ($session['user']['level']<15){        addnav("Kaufe 1 Edelstein ($costs[1] Gold)","gypsy.php?op=buy&level=1");        addnav("Kaufe 2 Edelsteine ($costs[2] Gold)","gypsy.php?op=buy&level=2");        addnav("Kaufe 3 Edelsteine ($costs[3] Gold)","gypsy.php?op=buy&level=3");    }    if (getsetting("selledgems",0)<25 && $session[user][level]>1) addnav("Verkaufe 1 Edelstein für $scost Gold","gypsy.php?op=sell");    // Passierschein A38    if(getsetting("p38_quest",0) && $session['user']['p38'] & 2) {        addnav("Besonderes");        addnav("Das blaue Formular","gypsy.php?op=p38");    }    addnav("Zurück");    addnav("Platz der alten Künste","kunstplatz.php");    addnav("Zurück zum Dorf","village.php");    output("`n`n`n");    viewcommentary("vessa","Mit anderen Bürgern reden",25,"sagt",1,1);}page_footer();

