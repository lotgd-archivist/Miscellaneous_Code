
<?phprequire_once "common.php";require_once "func/systemmail.php";require_once "func/farbcodes.php";addcommentary();$session[user][location]=20;page_header("Die Waldkapelle von Alvion");$session['user']['standort']="Waldkapelle";switch ($_GET['op']){    case "bestellsave":        output("`^`c`bAufgebot bestellen`b`c`6`n");        $sql = "INSERT INTO petitions (author,date,body,pageinfo,lastact,aufgebot) VALUES (".(int)$session[user][acctid].",now(),\"HOCHZEIT!!! HOCHZEIT!!! HOCHZEIT!!! \nBei Unklarheit Priester oder Admin ansprechen!\n".addslashes(output_array($_POST))."\",\"".addslashes(output_array($session,"Session:"))."\",NOW(),1)";        db_query($sql);        output("Dein Aufgebot wird nun von den Priestern geprüft. Ihr werdet eine Taube gesendet bekommen, mit weiteren Informationen.");        addnav ("Zurück","kapelle.php?op=trauen");    break;    case "aufgebot":        output("</form>",true);        output("`^`c`bAufgebot bestellen`b`c`6`n");        output("Trage bitte hier den Namen ".($session['user']['sex']?"deines ":"deiner ")." Verlobten, Name deiner Trauzeugen (Frage vorher ob sie wollen), und den Termin (Real) wann ihr heiraten wollt ein!`nDesweiteren hast du die Möglichkeit, etwaige Wünsche zu äußern.`n`n<form action='kapelle.php?op=bestellsave' method='POST'>          Name des/der Verlobten: <input name='Verlobte/r'>`n            Bestelle dein Aufgebot:`n            <textarea name='aufgebot' cols='60' rows='15' class='input'></textarea>`n            <input type='submit' class='button' value='Aufgebot bestellen'>`n            </form>            ",true);            allownav("kapelle.php?op=bestellsave");        addnav ("Lieber doch nicht","kapelle.php?op=trauen");    break;    case "beendete":        output("`c`b`2D`oi`ge `2Wa`@ld`oka`2pe`@ll`oe `gv`Go`gn `2A`ol`@vi`oo`2n`b`n`n`c");        $sql = "SELECT * FROM hzeit WHERE status=2";        output("`gHier im Buch der Trauungen kannst du alle bisherigen Hochzeiten aus Alvion sehen.`n                  Es wurde alles was geschehen ist in diesem Buch niedergeschrieben. Aufbewahrt bis in alle Ewigkeit....`n`n`n");        output("<table cellspacing=0 cellpadding=2 align='center'><tr><td>`b Hochzeit von:`b</td><td></td><td></td>",true);        if($session['user']['superuser']>=1) output("<td>`b Datum`b</td></td>",true);        output("<td>`b Priester/in`b</td>",true);        output("</tr>",true);        $result = db_query($sql) or die(db_error(LINK));        if (db_num_rows($result)==0)        {            output("<tr><td colspan=4 align='center'>`&`iKeine Hochzeiten gefunden`i`0</td></tr>",true);        }            for ($i=0;$i<db_num_rows($result);$i++)        {            $row = db_fetch_assoc($result);            $frau=closetags($row['frau'],'`c`i`b');            output("<tr><td>" . closetags($row['frau'],'`c`i`b') . "</td><td> `&und`0 </td><td>" . closetags($row['mann'],'`c`i`b') . "</td>",true);            if($session['user']['superuser']>=1) output("<td>" . $row['datum'] . "</td>",true);            output("<td>" . closetags($row['priester'],'`c`i`b') . "</td>",true);            output("</tr>",true);            }        output("</table>",true);        addnav ("Zurück","kapelle.php?op=trauen");        break;    case "trauen"://        addcommentary();        output("`c`b`2D`oi`ge `2Wa`@ld`oka`2pe`@ll`oe `gv`Go`gn `2A`ol`@vi`oo`2n`0`b`n`n`c");//        output("<img src='images/kapelle.gif'>`c`n",true);        output("`&Du trittst an den Traualtar, `ger ist wirklich eine Augenweide. `^Gold `gund `&Diamanten `gzieren seine Oberfläche,                oben drauf stehen zwei `Owunderschöne, `ggroße `OKerzen, `&auf einem `Rseidenen Tuch. ");       if ($session['user']['fragen']==5) output('`&Kaum trittst du in die Nähe des Altares, fällt dir an der östlichen Wand eine große Holztafel auf. Als du aus Neugier näher heran             gehst, kannst du in alten Lettern einige Namen erkennen, überschrieben mit `@„Priester dieses Landes“.`n`n`n`0');        output("`n`n`&Hier flüstern ein paar Anwesende:`n");    viewcommentary("kapelle_traualtar", "flüstert" , 25, "flüstert",1,1);        addnav ("Buch der Trauungen","kapelle.php?op=beendete");        if ($session['user']['fragen']==5) addnav("Aufgebot bestellen","kapelle.php?op=aufgebot");        addnav("Holztafel anschauen","kapelle.php?op=pmail");        if($session[user][superuser] >= 1){            addnav("Priester");            addnav ("Verheiraten","kapelle.php?op=schnellhochzeit");        }    addnav("Sonstiges");        addnav("Zurück zur Kapelle","kapelle.php");    break;    case "schnellhochzeit":        output("`@`b`cSchnellhochzeit`c`b`n`n");        output("`f`bBitte vor dem Verheiraten daran denken, das Einverständnis beider Hochzeitler einzuholen!`b`n`n");        output('`@wähle die Braut: ');        output('<form action="kapelle.php?op=ernst" method="post">',true);        addnav('','su_pchests.php?op=drin');        output('Springe direkt zu UserId. ');        output('<input type="text" name="id" size="4">',true);        output('<input type="submit" value="anzeigen"></form>',true);        output("Wähle die Brautpaare:`n`n");        output("<table cellpadding=2 align='center'><tr><td>`bUserId.`b</td><td>`bName`b</td><td> und </td><td>`bUserID`b</td><td>`bBräutigam`b</td></tr>",true);        $ppp=25; // Player Per Page +1 to display        if (!$_GET['limit']){            $page=0;        }else{            $page=(int)$_GET['limit'];            addnav("Vorherige Seite","kapelle.php?op=schnellhochzeit&limit=".($page-1)."");        }        $limit="".($page*$ppp).",".($ppp+1);        $sql = "SELECT acctid, login, name, marriedto, charisma, fragen, sex FROM accounts WHERE sex='1' AND marriedto!=4294967295 AND charisma>=4 AND fragen>=5 AND fragen<10 ORDER BY acctid ASC LIMIT $limit";        $result = db_query($sql) or die(db_error(LINK));        if (db_num_rows($result)>$ppp) addnav("Nächste Seite","kapelle.php?op=schnellhochzeit&limit=".($page+1)."");        if (db_num_rows($result)==0){            output("<tr><td colspan=3 align='center'>`&`iEs gibt keine anstehenden Trauungen`i`0</td></tr>",true);        }else{            for ($i=0;$i<db_num_rows($result);$i++){                $row2 = db_fetch_assoc($result);                $sql2="SELECT acctid, name FROM accounts WHERE acctid=".$row2['marriedto'];                $row3=db_fetch_assoc(db_query($sql2));                output("<tr><td align='center'>".$row2['acctid']."</td><td align='center'><a href='kapelle.php?op=ernst&id=".$row2['acctid']."&mann=".$row3['acctid']."'>".$row2['name']."</td><td> und </td><td>".$row3['acctid']."</td><td>".$row3['name']."</td></tr>",true);                allownav("kapelle.php?op=ernst&id=".$row2['acctid']."&mann=".$row3['acctid']);            }        }        output("</table>",true);        addnav("Zurück zur Kapelle","kapelle.php");        break;    case 'ernst':        output ("`&ID: ".$_GET['id']."       `&ID2: ".$_GET['mann']."`n");        $sql="SELECT acctid, name FROM accounts WHERE acctid='".$_GET['id']."'";        $frau=db_fetch_assoc(db_query($sql));        $sql="SELECT acctid, name FROM accounts WHERE acctid='".$_GET['mann']."'";        $mann=db_fetch_assoc(db_query($sql));        output($frau['name']." und ".$mann['name']." `&verheitaten?`n");        addnav("Jetzt wirds ernst!");        addnav("Ja - verheiraten!","kapelle.php?op=save&frau=".$frau['acctid']."&mann=".$mann['acctid']);        addnav("`\$Neiiiiin! `0Zurück!","kapelle.php?op=schnellhochzeit");        break;    case 'save':        $sql="SELECT acctid, name FROM accounts WHERE acctid=".$_GET['frau'];        $frau=db_fetch_assoc(db_query($sql));        $sql="SELECT acctid, name FROM accounts WHERE acctid=".$_GET['mann'];        $mann=db_fetch_assoc(db_query($sql));        $sql="UPDATE accounts SET fragen=10, charisma=4294967295 WHERE acctid=".$_GET['frau']." AND marriedto=".$_GET['mann'];        $result=db_query($sql);        $sql="UPDATE accounts SET fragen=10, charisma=4294967295 WHERE acctid=".$_GET['mann']." AND marriedto=".$_GET['frau'];        $result=db_query($sql);        output($frau['name']." `&und ".$mann['name']." `&sind nun verheiratet.`n");                addnews("`&".$frau['name']." `&und ".$mann['name']."`& haben heute feierlich den Bund der Ehe geschlossen!");        systemmail($frau['acctid'],"`&Ihr seid endlich ein Ehepaar!`0","`& Du und `&".$mann['name']."`& habt nach zahlreichen gemeinsamen Flirts im Garten, endlich geheiratet.`nGlückwunsch!");        systemmail($mann['acctid'],"`&Ihr seid endlich ein Ehepaar!`0","`& Du und `&".$frau['name']."`& habt nach zahlreichen gemeinsamen Flirts im Garten, endlich geheiratet.`nGlückwunsch!");        db_query("INSERT INTO hzeit (datum, macctid, mann, facctid, frau, pacctid, priester, status) VALUES(now(),'".$mann['acctid']."','".$mann['name']."','".$frau['acctid']."','".$frau['name']."','".$session['user']['acctid']."','".$session['user']['name']."','2')");        addnav("Zurück!","kapelle.php?op=schnellhochzeit");                break;    case "reden":        output("`c`b`2D`oi`ge `2Wa`@ld`oka`2pe`@ll`oe `gv`Go`gn `2A`ol`@vi`oo`2n`0`b`c`n`n");//        output("<img src='images/kapelle.gif'>`c`n",true);        output("`&Du setzt dich zu den Leuten auf die massive Kirchenbank und gespannt hörst du ihren Worten zu.`n`n");        viewcommentary("kapelle","Hier Flüstern",25,"sagt leise",1,1);        addnav("Zurück zur Kapelle","kapelle.php");    break;        case "priesterraum":        output("`c`b`2Der Priesterraum`0`b`c`n`n");//        output("<img src='images/kapelle.gif'>`c`n",true);        output("`&Dies ist ein Ort nur für die Priester, in dem ihr euch austauschen könnt, Ratschläge geben und/oder empfangen, oder auch Hochzeiten vorbereiten. Außerdem könnt ihr hier Termine absprechen, sollte dies mal nötig sein.`n`n`n");        viewcommentary("priesterraum","Raum für Diskussionen",25,"sagt leise",1,1);        addnav("Zurück zur Kapelle","kapelle.php");    break;    case "taufen":        output("`c`b`ODa`^s `OTau`^fb`Oeck`^e`On`b`c`n");        output("`g`n`&Du näherst dich dem kunstvollen `OTau`^fb`Oeck`^e`On. `&Es ist aus feinstem `OMarmor `&gefertigt und zeugt von alter Handwerkskunst.                Im Sockel des `OTau`^f`Obeck`^e`Ons `&siehst du ein dickes Buch, du holst es heraus und suchst nach deinem Namen und entdeckst eine                Liste deiner Kinder:`n`n`0");        if ($_GET[id] != "" && $_POST[tname] != ""){            if($session['user']['sex']){                $art="Mama";                $art2 = "ihre";            }else{                $art="Papa";                $art2 = "seine";            }            $sql="UPDATE kinder SET name = '" . $_POST[tname] . "' WHERE $art = " . $session[user][acctid] . " and id = " . $_GET[id];            $result = db_query($sql) or die(db_error(LINK));            $sql="SELECT * FROM kinder WHERE id = " . $_GET[id];            $result = db_query($sql) or die(db_error(LINK));            $row = db_fetch_assoc($result);            if ($row[geschlecht]){                addnews($session[user][name] . " hat " . $art2 ." Tochter auf den Namen " . $_POST[tname] . "`0 getauft.");            }else{                addnews($session[user][name] . " hat " . $art2 ."n Sohn auf den Namen " . $_POST[tname] . "`0 getauft.");            }        }        if ($_GET[id] != "" && $_POST[tname] == ""){                addnav("Zurück","kapelle.php?op=taufen");                output("<form action='kapelle.php?op=taufen&id=".$_GET[id]."' method='POST'>",true);                output("Taufname: <input name='tname'  maxlength=50 onkeyup=\"document.getElementById('chatpreview').innerHTML = appoencode(this.value);\"><span id='chatpreview'></span>`n`n", true);                output("<input type='submit' class='button' value='Taufen'></form>",true);                allownav("kapelle.php?op=taufen&id=".$_GET[id]);                farbcodes();        }else{            if ($session['user']['sex']){                $sql="SELECT * FROM kinder WHERE mama = " . $session[user][acctid];            }else{                $sql="SELECT * FROM kinder WHERE papa = " . $session[user][acctid];            }            output("<table border='0' cellpadding='3' cellspacing='0' align=center><tr class='trhead'><td style=\"width:275px\">Name</td><td style=\"width:150px\" align=center>Geburtsdatum</td><td style=\"width:75px\" align=center>Geschlecht</td><td>&nbsp;</td></tr>",true);            $result = db_query($sql) or die(db_error(LINK));            for ($i=0;$i<db_num_rows($result);$i++){                $row = db_fetch_assoc($result);                output("<tr class='".($i%2?"trlight":"trdark")."'><td>",true);                if ($row['name'] == ""){                    output("Neugeborenes", true);                }else{                    output($row['name'],true);                }                output("</td>",true);                output("<td>",true);                output("`c" . $row['gebdat'] . "`c",true);                output("</td>",true);                if ($row['geschlecht'] == 1){                    output("<td>`c<img src=images/female.gif>`c</td>", true);                }else{                    output("<td>`c<img src=images/male.gif>`c</td>", true);                }                if ($row['name'] == "" || $row['name'] =="`^Unbenannt`0"){                    output("<td>[<a href='kapelle.php?op=taufen&id=".$row[id]."'>Taufen</a>]</td></tr>",true);                    allownav("kapelle.php?op=taufen&id=".$row[id]."");                }else{                    output("<td>&nbsp;</td></tr>",true);                }            }            output("</table>",true);        }        addnav("Zurück zur Kapelle","kapelle.php");    break;        case 'pmail':        output('`&Nachdenklich lässt du deinen Blick über die Auflistung schweifen und erkennst, dass noch etwas darunter steht:             `@„Für jene, deren Herzen zueinander gefunden haben, sei gesagt, dass ihnen die unten aufgelisteten Wesen den Schwur der Ewigkeit abnehmen können.             Doch dazu ist es stets von Nöten, dass ein gemeinsamer Zeitpunkt durch eine vorherige Absprache gefunden wird, an dem eine Zeremonie             stattfinden kann. So lasst die Tauben fliegen, ihr liebenden Herzen.“`n`n`n`0');            $sql="SELECT `acctid`, `name`, `login`, `sex`, `laston`, `loggedin`, `race`, `prefs` FROM `accounts` WHERE `superuser`=1;";            $result = db_query($sql) or die(sql_error($sql));            $max = db_num_rows($result);            output("<table  align=\"center\" border=0 cellpadding=2 cellspacing=1 bgcolor=\"#999999\">",true);            output("<tr class='trdark'><td><b>Name</b></td><td><b><img src=\"images/female.gif\">/<img src=\"images/male.gif\"></b></td><td><b>Rasse</b></td><td><b>Gesinnung</b></td><td><b>Zuletzt da</b></td></tr>",true);            for($i=0;$i<$max;$i++){                $row = db_fetch_assoc($result);                $prefs=unserialize($row['prefs']);                output("<tr class='".($i%2?"trdark":"trlight")."'><td>",true);                output("<a href=\"mail.php?op=write&to=".rawurlencode($row['login'])."\" target=\"_blank\" onClick=\"".popup("mail.php?op=write&to=".rawurlencode($row['login'])."&subject=Hochzeit").";return false;\"><img src=\"images/newscroll.GIF\" width=\"16\" height=\"16\" alt=\"Mail schreiben\" border=\"0\"></a>"                    ."<a href=\"bio.php?char=".rawurlencode($row['login'])."&ret=".URLEncode($_SERVER['REQUEST_URI'])."\">",true);                output($row['name']);                output("</a></td><td align=\"center\">",true);                rawoutput($row[sex]?"<img src=\"images/female.gif\">":"<img src=\"images/male.gif\">");                output("</td><td>",true);                output($row['race']);                output("</td><td>",true);                if ((int)$prefs['priester']==1){                    output("Hell");                }elseif ((int)$prefs['priester']==2){                    output("Dunkel");                }else    if ((int)$prefs['priester']==3){                    output("Hell/Dunkel");                }else{                    output("Unbekannt");                }                output("</td><td>",true);                $loggedin=(date("U") - strtotime($row[laston]) < getsetting("LOGINTIMEOUT",900) && $row[loggedin]);                $laston=round((strtotime(date("c"))-strtotime($row[laston])) / 86400,0)." Tage";                if (substr($laston,0,2)=="1 ") $laston="1 Tag";                if (date("Y-m-d",strtotime($row[laston])) == date("Y-m-d")) $laston="Heute";                if (date("Y-m-d",strtotime($row[laston])) == date("Y-m-d",strtotime(date("c")."-1 day"))) $laston="Gestern";                if ($loggedin) $laston="Jetzt";                output($laston);                output("</td></tr>",true);                allownav("bio.php?char=".rawurlencode($row['login'])."&ret=".URLEncode($_SERVER['REQUEST_URI']));            }            output("</tr></table>",true);            addnav("zurück","kapelle.php?op=trauen");    break;        default:        if ($session['user']['sex']){            $sqlkin = "SELECT * FROM kinder where mama = " . $session['user']['acctid'];        }else{            $sqlkin = "SELECT * FROM kinder where papa = " . $session['user']['acctid'];        }        $resultkin = db_query($sqlkin);        $kinder = array();        while ($rowkin = db_fetch_assoc($resultkin)){            array_push($kinder, $rowkin['name']);        }        output("`c`b`2D`oi`ge `2Wa`@ld`oka`2pe`@ll`oe `gv`Go`gn `2A`ol`@vi`oo`2n`0`b`n`n");        output("<img src='images/kapelle.gif'>`c`n`n",true);        output("`gDu betrittst die kleine `2Wa`@ld`oka`2pe`@ll`oe , `gdurch eine `^rei`8ch`^verz`8ie`^rte `tHolztür, `gdie von einem Rahmen aus `8edelstem `OMarmor `gumzogen wird.                Als du in die `&heiligen Hallen `geintrittst, wunderst du dich über die Grösse der `oKa`2pe`@ll`oe, `gdenn von aussen wirkt sie doch                eher unscheinbar. Aber innen ist sie `^rei`8ch`^verz`8ie`^rt, `gmit den `&feinsten `^St`Ouc`^ka`Or`^be`Oit`^en `gund `2W`oa`gn`2d- `gund `2De`ock`@en`gmal`@er`oei`2en.                `gDu erkennst wundervolle `2Ra`onk`@e`gnm`@u`ost`2er mit `^goldverzierten `2B`ol`@ät`gt`@e`or`2n `gund ein Meer von `&weissen Blüten `gdie sich über die Kuppel der `2Wa`@ld`oka`2pe`@ll`oe `gausbreiten und dir das Gefühl geben mitten in der `2N`oa`@t`ou`2r zu stehen.                `gDies ist also die `2D`oi`ge `2Wa`@ld`oka`2pe`@ll`oe `gv`Go`gn `2A`ol`@vi`oo`2n`g.`n`n"                );        if ($session['user']['charisma']==4294967295){            output("`g`iUnwillkürlich erinnerst du dich an Deine eigene Hochzeit und würdest am liebsten nochmal heiraten.`i`n");        }else{            output("`g`iMöchtest du nicht auch langsam mal hier stehen und heiraten?`i`n");        }        if ($kinder[0] != ""){            if($session['user']['sex']){                output("`n`^`iAls Mutter von ");                output(implode(", ", $kinder));                output("`g, erinnerst du dich auch an die wunderschöne Taufzeremonie und schwelgst in deinen Erinnerungen....`i`n`0");            }else{                output("`n`^`iAls Vater von ");                output(implode(", ", $kinder));                output("`g, erinnerst du dich auch an die wunderschöne Taufzeremonie und schwelgst in deinen Erinnerungen....`i`n`0");            }        }        output("`n`gDu lässt deinen Blick weiter schweifen und erblickst Leute, die leise redend auf einer massiven Kirchenbank sitzen.                Linker Hand entdeckst du den Traualtar, ");        if ($session['user']['charisma']==4294967295){            output("an dem du ".($session['user']['sex']?"deinen Mann":"deine Frau")." geheiratet hast.`n");        }else{            output("an dem du vielleicht in naher Zukunft heiraten wirst.`n");        }        output("Zu deiner Rechten erblickst du das Taufbecken, ");        if ($kinder[0] != ""){            output("an dem deine Kinder getauft worden sind.`n");        }else{            output("an dem vielleicht mal deine Kinder einen Namen erhalten werden.`n");        }        output("Was möchtest du tun?");        navhead("Aktionen");        addnav("Zum Traualtar","kapelle.php?op=trauen");        addnav("Zu den anderen setzen","kapelle.php?op=reden");        addnav("Zum Taufbecken","kapelle.php?op=taufen");        if($session[user][superuser] >=1) addnav("Zum Priesterraum","kapelle.php?op=priesterraum");        navhead("Sonstiges");                addnav("Zurück zum Dorf","village.php");    break;}if($session[user][superuser] >=2) addnav("X?Zur Admingrotte","superuser.php");page_footer();

