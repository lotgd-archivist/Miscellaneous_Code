
<?php    ///////////////////////////////////////////////////    //Dancehouse.php by Auric            ///    //reconstrucktion of Danchehall by Lightbringer    ///    //last Update: 09.1!.05 =>version 1.10 (bugfix)    ///    //from Server: www.blood-reaver.de/logd/index.php//    //for info contact: admin@blood-reaver.de    ///    //using GNU GPL                    ///    ////////////////////////////////////////////////////*    ###Installation###//Datenbank:ALTER TABLE accounts ADD dance VARCHAR( 50 ) DEFAULT '0' NOT NULL;ALTER TABLE accounts ADD danceby VARCHAR( 50 ) DEFAULT 'none' NOT NULL;ALTER TABLE accounts ADD hasdanced tinyint(3) NOT NULL default '0';//php-dateien:    //in Beliebige Ausgangsdatei einfügen (meist village.php)addnav("Tanzsaal","dancehouse.php");    //in der newday.php:find:$session['user']['seenbard'] = 0;after or before Add:$session['user']['hasdanced'] = 0;    //bei belieben in der hexe.phpfind:} else if ($_GET[op] == "barde"){    output("`!\"`%Soso, der Barde will nicht mehr für dich singen. Hättest du ihm diesen Edelstein gegeben statt mir, hätte er sicher gesungen. Weißt du was? Ich werde ihm diesen Edelstein vor die Füße zaubern und ihn ");    output(" wissen lassen, daß er von dir ist. So wie ich ihn kenne, steckt er ihn sich in die löchrige Hosentasche und verliert ihn in der Kneipe wieder ... aber was solls.`!\" Damit legt die Hexe ");    output("den Edelstein auf den Tisch und schüttet etwas von ihrem Punsch darüber. \"`%Schon gut, du kannst gehen.`!\" sagt sie noch zu dir und während du dich ");    output("Richtung Wald umdrehst, siehst du den Edelstein verschwinden... `n`n");    $session[user][gems]--;    $session[user][seenbard]=0;    forest(true);after add:} else if ($_GET[op] == "tanzen") {    output("`!\"`%Ach, wir möchten nochmal das Tanzbein schwingen, so ist das. Jaja, und ich soll nun deine Füße \"Umstimmen\" *seufz*, na gut, du bezahlst ja`!\"`n");    output("Die Hexe bricht in ein Kichern aus, das klingt, wie ein Frettchen mit Nebenhöhlenentzünung. Doch dann beginnt sie immer schneller Worte zu sprechen, die dir den Kopf schwirren lassen.`n");    output("Dann sieht sie dich an und fragt: \"`%So, genug der Effekte. Trink das, und du kannst heute noch eine Runde drehen! Keine Angst, ist nur Kamillentee!`!\", gackert sie und drückt dir ein Fläschchen in die Hand und dich aus der Hütte.");    $session[user][hasdanced]=0;    $session[user][gems]--;    forest(true);find:if ($session[user][seenbard] && $session[user][gems]) addnav("Bardenhals befeuchten (1 Edelstein)","hexe.php?op=barde");after add:if ($session[user][hasdanced] && $session[user][gems]) addnav("Tanzbein flottmachen (1 Edelstein)","hexe.php?op=tanzen");//das wars auch schon. Eventuell noch die Dancehouse.php für "zurück" modifizieren.//normal führt sie in die village.php zurück.*/require_once "common.php";require_once "func/systemmail.php";require_once "func/func_forest.php";addcommentary();checkday();global $session;$hasdanced=$session[user][hasdanced];$username=$session[user][login];$session['user']['standort']="Tanzsaal";if($_GET[act]=="look") {    $danceby=$session[user][danceby];    if($danceby==="none") {        page_header("Tanzpartnersuche");        if($hasdanced<3) {            output("`XDu gehst umher und suchst nach einem passenden Tanzpartner`n");                if (isset($_POST['search']) || $_GET['search']>""){                    if ($_GET['search']>"") $_POST['search']=$_GET['search'];                    $search="%";                    for ($x=0;$x<strlen($_POST['search']);$x++){                        $search .= substr($_POST['search'],$x,1)."%";                    }                    $search="name LIKE '".$search."' AND ";                }else{                    $search="";                }                $ppp=25; // Player Per Page to display                if (!$_GET[limit]){                    $page=0;                }else{                    $page=(int)$_GET[limit];                    addnav("Vorherige Seite","dancehouse.php?act=look&limit=".($page-1)."&search=$_POST[search]");                }                $limit="".($page*$ppp).",".($ppp+1);                output("Für wen entscheidest du dich?`0`n`n");                output("<form action='dancehouse.php?act=look&gesch=$_GET[gesch]' method='POST'>Nach Name suchen: <input name='search' value='$_POST[search]'><input type='submit' class='button' value='Suchen'></form>",true);                allownav("dancehouse.php?act=look&gesch=$_GET[gesch]");                  $sql = "SELECT acctid,name,sex,level,race,login,marriedto,charisma FROM accounts WHERE                $search                (locked=0) AND                                (sex ".($_GET['gesch']?"= ":"<> ").$session[user][sex].") AND                                (danceby = 'none') AND                (alive=1) AND                (acctid <> ".$session[user][acctid].") AND                (laston > '".date("Y-m-d H:i:s",strtotime(date("c")."-346000 sec"))."' OR (charisma=4294967295 AND acctid=".$session[user][marriedto].") )                ORDER BY (acctid=".$session['user']['marriedto'].") DESC, charm DESC LIMIT $limit";                  $result = db_query($sql) or die(db_error(LINK));                output("<table border='0' cellpadding='3' cellspacing='0'><tr><td>",true);                output("</td><td><b>Name</b></td></td><td><b>Rasse</b></td><td><b>Status</b><td><b>Ops</b></td></tr>",true);                if (db_num_rows($result)>$ppp) addnav("Nächste Seite","dancehouse.php?act=look&limit=".($page+1)."&search=$_POST[search]");                for ($i=0;$i<db_num_rows($result);$i++){                    $row = db_fetch_assoc($result);                      $biolink="bio.php?char=".rawurlencode($row[login])."&ret=".urlencode($_SERVER['REQUEST_URI']);                      $dancelink="dancehouse.php?act=dance&with=".rawurlencode($row[login])."&sex=".($session[user][sex]?"male":"female")."&gesch=$_GET[gesch]&ret=".urlencode($_SERVER['REQUEST_URI']);                      addnav("", $dancelink);                      addnav("", $biolink);                    if ($session[user][charisma]<=$row[charisma]) $flirtnum=$session[user][charisma];                    if ($row[charisma]<$session[user][charisma]) $flirtnum=$row[charisma];                      output("<tr class='".($i%2?"trlight":"trdark")."'><td>".($row['sex']?"<img src=\"images/female.gif\">":"<img src=\"images/male.gif\">")."</td><td>$row[name]</td><td>",true);                    output($row['race']);                    output("</td><td>",true);                    output("-");                    output("</td><td>[ <a href='$biolink'>Bio</a> | <a href='$dancelink'>Tanzen</a> ]</td></tr>",true);                }                output("</table>",true);            addnav("Zurück zum Saal","dancehouse.php");            addnav("Nochmal sehen","dancehouse.php?act=look&gesch=$_GET[gesch]");        }else {            output("`QDu hast heute schon genug getanzt und bist du zu erschöpft, um noch eine Runde zu drehen.`n Du kannst morgen wieder tanzen");            addnav("Zurück zum Saal","dancehouse.php");        }    } else {        page_header("Aufforderungen Prüfen");        if($session[user][sex]) {            if($_GET[gesch]==1){                $sex=array("eine Dame", "sie", "Damen", "Ihr");            }else{                $sex=array("einen Herren", "ihn", "Herren", "Ihm");            }        }else {            if($_GET[gesch]==1){                $sex=array("einen Herren", "ihn", "Herren", "Ihm");            }else{                $sex=array("eine Dame", "sie", "Damen", "Ihr");            }        }        output("`^Gerade willst du dir $sex[0] suchen, um $sex[1] zum Tanz aufzufordern, als du bemerkst, dass`$ $danceby `^dich gerade aufforden möchte!`n");        output("`c`#Was tust du nun?`c");        $gonav="dancehouse.php?act=godance&char=" . rawurlencode($danceby);        $declinenav="dancehouse.php?act=decline&char=" . rawurlencode($danceby);        if($hasdanced>=3) {            output("`XDoch da du heute schon genug getanzt hast, bist du zu erschöpft, um noch eine Runde zu drehen.`n Du kannst`$ $danceby `X nur absagen oder euren Tanz auf morgen verscheiben!");            addnav("Verschieben!","dancehouse.php");            addnav("Ablehnen!",$declinenav);        } else {            addnav("Annehmen!",$gonav);            addnav("Verschwinden!","dancehouse.php");            addnav("Ablehnen!",$declinenav);        }    }} elseif($_GET[act]=="decline") {    $ex=$session[user][danceby];    $usrname=$session[user][login];    $sql = "SELECT acctid, login FROM accounts WHERE login=\"$ex\"";    $result = db_query($sql) or die(db_error(LINK));    $row = db_fetch_assoc($result);    $partnerid=$row[acctid];    $partner=$row['login'];    page_header("Aufforderung von $ex ablehnen");    systemmail($row['acctid'],"`4Aufforderung abgelehnt","`$ $usrname `4hat deine Aufforderung zum Tanz leider abgelehnt. `nVieleicht findest du ja einen anderen Partner.");    switch(round(rand(1,5))) {        case 2:            output("`6Zwar hast du`$ $ex `6die eiskalte Schulter gezeigt, aber so wirklich gut fühlst du dich trotzdem nicht.`n");            output("`c`%Dir vergeht die Laune und du möchtest heute nicht mehr tanzen.`c");            addnav("Nach draußen","vergnueviertel.php");            $session[user][hasdanced]++;            $session[user][dance]=0;            $session[user][danceby]="none";//            $sql="UPDATE accounts SET dance='0', charm=charm+2 WHERE login='$partner'";            $sql="UPDATE accounts SET dance='0' WHERE login='$partner'";            db_query($sql);        break;        case 3:            output("`^Du sagst`$ $ex `^ab, doch anscheinend wirst du dabei von einigen anderen Tänzern gesehen, die sofort zu lästern beginnen.`n");            output("`c`5Du verlierst daher an Charme`c");            addnav("Zurück zur Tanzfläche","dancehouse.php?act=look");            addnav("Nach draußen","vergnueviertel.php");            $session[user][charm]--;            $session[user][dance]=0;            $session[user][danceby]="none";//            $sql="UPDATE accounts SET dance='0', charm=charm+2 WHERE login='$partner'";            $sql="UPDATE accounts SET dance='0' WHERE login='$partner'";            db_query($sql);        break;        case 4:            output("`9Du willst`$ $ex `9absagen, doch bringst es nicht übers Herz. Statt dessen geht ihr gemeinsam eine Tasse Kaffe trinken, wobei du es dann doch über dich bringst.");            output("`c $ex `#ist zwar ein wenig enttäuscht, bedankt sich aber für deine Höflichkeit. Sogleich fühlst du dich charmanter!`c");            addnav("Zurück zur Tanzfläche","dancehouse.php?act=look");            addnav("Zurück ins Dorf","village.php");            $session[user][charm]++;            $session[user][dance]=0;            $session[user][danceby]="none";//            $sql="UPDATE accounts SET dance='0', charm=charm+2 WHERE login='$partner'";            $sql="UPDATE accounts SET dance='0' WHERE login='$partner'";            db_query($sql);        break;        default:            output("`@Du sagst $ex ab und machst dich statt dessen auf die Suche nach einem anderen Tanzpartner`n`n");            addnav("Zurück zur Tanzfläche","dancehouse.php?act=look");            addnav("Zurück ins Dorf","village.php");            $session[user][dance]=0;            $session[user][danceby]="none";//            $sql="UPDATE accounts SET dance='0', charm=charm+2 WHERE login='$partner'";            $sql="UPDATE accounts SET dance='0' WHERE login='$partner'";            db_query($sql);        break;        }        // Transferbugfix        updateuser($partnerid,array('dance'=>"0", 'charm'=>"+2"));} elseif($_GET[act]=="godance") {    page_header("Tanzen!");    $partner=$session[user][danceby];    $usrname=$session[user][login];    $partnername=$session['user']['name'];    $sql = "SELECT acctid FROM accounts WHERE login=\"$partner\"";    $result = db_query($sql);    $row = db_fetch_assoc($result);    $partnerid=$row[acctid];    output("`c `%Du nimmst die Aufforderung von`$ $partner `%an!`c`n`9Ihr hakt euch ein und geht beide innerlich lächelnd auf die Tanzfläche. ");    output("Ihr beginnt euch zur Musik zu bewegen und werdet dabei immer schneller. Du fühlst dich außerordentlich gut dabei, doch in der Freude geht alles so schnell vorbei, dass du dich und $partner schon bald etwas erschöpft am Rand wiederfindest.");    output("`nZufrieden blickst du $partner an und bedankst dich. Darauf hin geht ihr beide eurer Wege.");    output("`n`n`c`%Du bist zwar etwas erschöpft, aber das war es wert! Ihr erhaltet `^ZWEI CHARMEPUNKTE!`c`0");    $session[user][charm]+=2;    $session[user][dance]=0;    $session[user][danceby]="none";    $session[user][hasdanced]++;    systemmail($row['acctid'],"`^Aufforderung angenommen!`0","`& $partnername `%Hat deine Tanzaufforderung angenommen und eine wunderbare Zeit mit dir auf der Tanzfläche verbracht!`n Du erhältst `^ZWEI CHARMEPUNKTE!");//    $sql="UPDATE accounts SET danceby='none',dance='0',charm=charm+2 WHERE login='$partner'";    $sql="UPDATE accounts SET danceby='none',dance='0' WHERE login='$partner'";    db_query($sql);    // Transferbugfix    updateuser($partnerid,array('danceby'=>"none", 'dance'=>"0", 'charm'=>"+2"));    addnav("Zurück zum Saal","dancehouse.php");    addnav("Zurück ins Dorf","village.php");    } elseif($_GET[act]=="dance") {    page_header("Aufforderung");    if($_GET[sex]=="female") {        if($_GET[gesch]==1){            $sex=array(    "er", "seine", "ihn");        }else{            $sex=array(    "sie", "ihre", "sie");        }    } else {        if($_GET[gesch]==1){            $sex=array(    "sie", "ihre", "sie");        }else{            $sex=array(    "er", "seine", "ihn");        }    }//    $ex=$session[user][danceby];    $usrname=$session[user][login];    $withname=$_GET[with];    $sql = "SELECT acctid, name FROM accounts WHERE login=\"$withname\"";    $result = db_query($sql);    $row = db_fetch_assoc($result);    $partnerid=$row[acctid];    $partnername=$session['user']['name'];    output("Du nimmst deinen Mut zusammen und gehst auf $withname zu, um $sex[2] zu einem Tanz aufzufordern!`n");    output("`c`%Du glaubst es selbst kaum, du hast `^$withname `%tatsächlich angesprochen!`n Gespannt wartest du auf $sex[1] Antwort und guckst $sex[2] möglichst verführerisch an.`n`n");    output("`^Nun musst du nur Geduld haben`c");    $session[user][dance]=$_GET[with];    $session['user']['hasdanced']++;    // nur nzum text: output("`n Test:  $usrname und $withname");    $sql="UPDATE accounts SET danceby='$usrname' WHERE login='$withname'";    db_query($sql);    // Transferbugfix    updateuser($partnerid,array('danceby'=>$usrname));//    $sql1="UPDATE accounts SET danceby='none' WHERE login='$ex'";//    db_query($sql1) or die(LINK);    addnav("Zurück zur Auswahl","dancehouse.php?act=look");    addnav("Zurück zum Saal","dancehouse.php?go=dance");    systemmail($row['acctid'],"`^Tanzaufforderung`0","`& $partnername `%hat dich zu einem Tanz im Saal aufgefordert!`nNun ist deine Entscheidung vonnöten!");} else {    page_header("Tanzsaal");    output("`c`b`XTa`qn`Qzs`qa`Xal`b`c`n`n `XDu betrittst den g`qroßen Tanzsaal. Üb`Qerall siehst die ve`qrliebte oder befr`Xeundete Pärchen, d`qie sich auf dem P`Qarkett bewegen o`qder an einigen Ti`Xschen weiter hinte`qn im Saal sitz`Qen.`n");    output("Etwas erhöht a`quf einer Bühne sie`Xhst du einige Mu`qsiker, die ihren In`Qstrumenten die Kl`qänge entlocken, z`Xu denen getan`qzt wird.`n`n");    output("`XAlles wirkt sehr festlich und dir wird bewusst, dass du dich hier besser benehmen solltest.`0`n`n");        addnav("Tanzsaal");    if($session[user][sex]==1) {        output("`QMöchtest du nicht vieleicht nach einem hübschen Herren als Tanzpartner ausschau halten?`nOder traust du dich nicht und willst lieber wieder gehen?`n`n");        addnav("`4Einen hübschen Kerl suchen","dancehouse.php?act=look&gesch=0");        addnav("`%Eine Schöne zum Tanz fordern","dancehouse.php?act=look&gesch=1");    } else {        output("`6Viele hübsche junge Damen laufen hier herum, möchtest du eine von ihnen zum Tanz auffordern, oder lieber verschwinden, ehe dich jemand sieht?`n`n");        addnav("`4Eine Schöne zum Tanz fordern","dancehouse.php?act=look&gesch=0");        addnav("`%Einen hübschen Kerl suchen","dancehouse.php?act=look&gesch=1");    }    viewcommentary("Tanzsaal","Mit anderen Tänzern unterhalten",25,"sagt",1,1);    addnav("Ausgang");    addnav("Nach draußen","vergnueviertel.php");    addnav("Z?Zurück ins Dorf","village.php");}page_footer();

