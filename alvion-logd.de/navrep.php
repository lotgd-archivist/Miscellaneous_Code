
<?require_once "common.php";if($_GET['op'] == "edit"){    $sql = "UPDATE accounts SET allowednavs='' WHERE acctid=$_GET[userid]";    db_query($sql);    $file = fopen('./cache/c'.$_GET['userid'].'.txt','wb');    fwrite($file,'');    fclose($file);    output("`^`bNavigationsdaten wurden repariert!`b`n`n");}elseif($_GET['op'] == "search"){    $sql = "SELECT acctid FROM accounts WHERE ";    $where="    login LIKE '%{$_POST['q']}%' OR    acctid LIKE '%{$_POST['q']}%' OR    name LIKE '%{$_POST['q']}%' OR    emailaddress LIKE '%{$_POST['q']}%' OR    lastip LIKE '%{$_POST['q']}%' OR    uniqueid LIKE '%{$_POST['q']}%' OR    gentimecount LIKE '%{$_POST['q']}%' OR    level LIKE '%{$_POST['q']}%'";    $result = db_query($sql.$where);    if (db_num_rows($result)<=0){        output("`\$Keine Ergebnisse gefunden`0");        $_GET[op]="";        $where="";    }elseif (db_num_rows($result)>100){        output("`\$Zu viele Ergebnisse gefunden. Bitte Suche einengen.`0");        $_GET[op]="";        $where="";    }elseif (db_num_rows($result)==1){        //$row = db_fetch_assoc($result);        //redirect("navrep.php?op=edit&userid=$row[acctid]");        $_GET[op]="";        $_GET['page']=0;    }else{        $_GET[op]="";        $_GET['page']=0;    }}page_header("Spieler-Navigation reparieren");    output("<form action='navrep.php?op=search' method='POST'>Suche in allen Feldern: <input name='q' id='q'><input type='submit' class='button'></form>",true);    output("<script language='JavaScript'>document.getElementById('q').focus();</script>",true);    addnav("","navrep.php?op=search");    addnav("Zurück zur Grotte","superuser.php");if ($_GET[op]==""){    if (isset($_GET['page'])){        $order = "acctid";        if ($_GET[sort]!="") $order = "$_GET[sort]";        $offset=(int)$_GET['page']*100;        $sql = "SELECT acctid,login,name,level,laston,gentimecount,lastip,uniqueid,emailaddress FROM accounts ".($where>""?"WHERE $where ":"")."ORDER BY \"$order\" LIMIT $offset,100";        $result = db_query($sql) or die(db_error(LINK));        output("<table>",true);        output("<tr>        <td>Ops</td>        <td><a href='navrep.php?sort=login'>Login</a></td>        <td><a href='navrep.php?sort=name'>Name</a></td>        <td><a href='navrep.php?sort=level'>Lev</a></td>        <td><a href='navrep.php?sort=laston'>Zuletzt da</a></td>        </tr>",true);        addnav("","navrep.php?sort=login");        addnav("","navrep.php?sort=name");        addnav("","navrep.php?sort=level");        addnav("","navrep.php?sort=laston");        $rn=0;        for ($i=0;$i<db_num_rows($result);$i++){            $row=db_fetch_assoc($result);            $laston=round((strtotime(date("c"))-strtotime($row[laston])) / 86400,0)." Tage";            if (substr($laston,0,2)=="1 ") $laston="1 Tag";            if (date("Y-m-d",strtotime($row[laston])) == date("Y-m-d")) $laston="Heute";            if (date("Y-m-d",strtotime($row[laston])) == date("Y-m-d",strtotime(date("c")."-1 day"))) $laston="Gestern";            if ($loggedin) $laston="Jetzt";            $row[laston]=$laston;            if ($row[$order]!=$oorder) $rn++;            $oorder = $row[$order];            output("<tr class='".($rn%2?"trlight":"trdark")."'>",true);            output("<td>",true);            output("[<a href='navrep.php?op=edit&userid=$row[acctid]'>`&Reparieren</a>]",true);            addnav("","navrep.php?op=edit&userid=$row[acctid]");            output("</td><td>",true);            output($row[login]);            output("</td><td>",true);            output($row[name]);            output("</td><td>",true);            output($row[level]);            output("</td><td>",true);            output($row[laston]);            output("</td>",true);            $gentimecount+=$row[gentimecount];            $gentime+=$row[gentime];            output("</tr>",true);        }        output("</table>",true);        output("Treffer gesamt: $gentimecount`n");        output("CPU-Zeit gesamt: ".round($gentime,3)."s`n");        output("Durchschnittszeit für Seitenerzeugung: ".round($gentime/max($gentimecount,1),4)."s`n");    }}page_footer();?>

